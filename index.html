<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人日程表</title>
    <style>
        /* 全局样式重置和基础设置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", "Comic Sans MS", sans-serif; /* 加入可爱字体 */
        }

        body {
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* 垂直居中 */
            min-height: 100vh; /* 占满视口高度 */
            padding: 20px;
            color: #333;
            transition: background-color 0.3s ease;
        }

        /* 颜色主题变量 - 初始为浅蓝色 */
        :root {
            --primary-color: #6fa8dc; /* 主色-浅蓝色 */
            --primary-light: #e8f4f8; /* 主色浅色调 */
            --primary-deep: #4a89dc; /* 主色深色调 */
            --primary-shadow: rgba(111, 168, 220, 0.3); /* 阴影色 */
            --btn-color: #6fa8dc; /* 按钮色 */
            --btn-hover: #4a89dc; /* 按钮hover */
            --init-bg: white; /* 初始化区域背景 */
            --init-shadow: rgba(111, 168, 220, 0.3); /* 初始化区域阴影 */
            --input-border: #cce5ff; /* 输入框边框 */
            --input-focus: #99ccff; /* 输入框聚焦 */
            --today-bg: white; /* 今日背景色改为白色 */
            --today-shadow: rgba(255, 232, 161, 0.8); /* 今日阴影 */
            --today-text-color: #ffc107; /* 今日文字颜色-黄色 */
        }

        /* 浅粉色主题 */
        body.pink-theme {
            --primary-color: #ff9aa2; /* 浅粉色 */
            --primary-light: #fff0f1; /* 浅粉色浅色调 */
            --primary-deep: #ff6b8b; /* 浅粉色深色调 */
            --primary-shadow: rgba(255, 192, 203, 0.3); /* 粉色阴影 */
            --btn-color: #ff6b8b; /* 按钮色 */
            --btn-hover: #ff4757; /* 按钮hover */
            --init-shadow: rgba(255, 192, 203, 0.3); /* 初始化区域阴影 */
            --input-border: #ffc0cb; /* 输入框边框 */
            --input-focus: #ff6b8b; /* 输入框聚焦 */
            --today-bg: white; /* 今日背景色改为白色 */
            --today-shadow: rgba(255, 192, 203, 0.8); /* 今日阴影 */
            --today-text-color: #ffc107; /* 今日文字颜色-黄色 */
        }

        /* 浅蓝色主题（默认） */
        body.blue-theme {
            --primary-color: #6fa8dc; /* 浅蓝色 */
            --primary-light: #e8f4f8; /* 浅蓝色浅色调 */
            --primary-deep: #4a89dc; /* 浅蓝色深色调 */
            --primary-shadow: rgba(111, 168, 220, 0.3); /* 蓝色阴影 */
            --btn-color: #6fa8dc; /* 按钮色 */
            --btn-hover: #4a89dc; /* 按钮hover */
            --init-shadow: rgba(111, 168, 220, 0.3); /* 初始化区域阴影 */
            --input-border: #cce5ff; /* 输入框边框 */
            --input-focus: #99ccff; /* 输入框聚焦 */
            --today-bg: white; /* 今日背景色改为白色 */
            --today-shadow: rgba(179, 217, 255, 0.8); /* 今日阴影 */
            --today-text-color: #ffc107; /* 今日文字颜色-黄色 */
        }

        /* 浅绿色主题 */
        body.green-theme {
            --primary-color: #82c91e; /* 浅绿色 */
            --primary-light: #f1f8e9; /* 浅绿色浅色调 */
            --primary-deep: #69b119; /* 浅绿色深色调 */
            --primary-shadow: rgba(130, 201, 30, 0.3); /* 绿色阴影 */
            --btn-color: #82c91e; /* 按钮色 */
            --btn-hover: #69b119; /* 按钮hover */
            --init-shadow: rgba(130, 201, 30, 0.3); /* 初始化区域阴影 */
            --input-border: #c3e6cb; /* 输入框边框 */
            --input-focus: #82c91e; /* 输入框聚焦 */
            --today-bg: white; /* 今日背景色改为白色 */
            --today-shadow: rgba(212, 237, 218, 0.8); /* 今日阴影 */
            --today-text-color: #ffc107; /* 今日文字颜色-黄色 */
        }

        /* 初始化区域样式（优化：可爱风格+居中+颜色选择） */
        .init-section {
            text-align: center;
            width: 100%;
            max-width: 400px;
            background-color: var(--init-bg);
            padding: 40px 30px;
            border-radius: 20px;
            box-shadow: 0 8px 24px var(--init-shadow); /* 主题阴影 */
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        /* 颜色选择器样式 */
        .color-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .color-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: transform 0.2s ease; /* 只保留放大效果，移除box-shadow过渡 */
            position: relative;
        }

        .color-btn:hover {
            transform: scale(1.1);
        }

        /* 取消active状态的圆环效果 */
        .color-btn.active {
            box-shadow: none; /* 移除圆环效果 */
            transform: scale(1.1); /* 保持放大效果 */
        }

        .color-btn.pink {
            background-color: #ff9aa2; /* 浅粉色 */
        }

        .color-btn.blue {
            background-color: #6fa8dc; /* 浅蓝色 */
        }

        .color-btn.green {
            background-color: #82c91e; /* 浅绿色 */
        }

        .init-title {
            font-size: 22px;
            color: var(--primary-color);
            margin-bottom: 20px;
            font-weight: bold;
        }

        .init-input {
            padding: 12px 15px;
            font-size: 16px;
            border: 2px solid var(--input-border); /* 主题边框 */
            border-radius: 12px;
            width: 100%;
            margin-bottom: 15px;
            outline: none;
            transition: border-color 0.3s;
        }

        .init-input:focus {
            border-color: var(--input-focus); /* 主题聚焦色 */
            box-shadow: 0 0 8px var(--primary-shadow);
        }

        .init-btn {
            padding: 12px 20px;
            font-size: 16px;
            background-color: var(--btn-color); /* 主题按钮色 */
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
            font-weight: bold;
        }

        .init-btn:hover {
            background-color: var(--btn-hover); /* 主题hover */
        }

        /* 标题样式 */
        .calendar-title {
            font-size: 28px;
            color: var(--primary-color);
            margin-bottom: 20px;
            display: none; /* 初始隐藏，输入名字后显示 */
            text-shadow: 1px 1px 3px var(--primary-shadow);
            transition: color 0.3s ease;
        }

        /* 日历容器样式 */
        .calendar-container {
            width: 100%;
            max-width: 800px;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            padding: 20px;
            display: none; /* 初始隐藏，输入名字后显示 */
            position: relative;
        }

        /* 日程表右上角颜色选择器（调整位置） */
        .calendar-color-selector {
            position: absolute;
            top: 20px; /* 与月份栏同高度 */
            right: 20px; /* 调整到右上角 */
            display: flex;
            gap: 10px;
            z-index: 10;
            align-items: center;
        }

        /* 月份切换区域（重构布局） */
        .month-nav {
            display: flex;
            justify-content: center; /* 整体居中 */
            align-items: center;
            margin-bottom: 20px;
            gap: 15px; /* 按钮和文字之间的间距 */
        }

        .nav-btn {
            font-size: 20px; /* 调整字体大小 */
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 50%;
            transition: background-color 0.3s, color 0.3s ease;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn:hover {
            background-color: var(--primary-light);
        }

        .current-month {
            font-size: 22px;
            color: #333;
            font-weight: bold;
        }

        /* 日历表格样式 */
        .calendar-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed; /* 关键：固定表格布局，防止列宽变化 */
        }

        .calendar-table th {
            padding: 15px;
            text-align: center;
            background-color: var(--primary-light);
            color: var(--primary-color);
            font-size: 16px;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
            width: 14.28%; /* 固定表头宽度 */
        }

        /* 关键修改1：强化单元格固定尺寸，添加overflow:hidden确保内容不溢出 */
        .calendar-table td {
            padding: 10px 5px;
            text-align: center;
            border: 1px solid #e9ecef;
            height: 90px; /* 固定高度，防止变形 */
            width: 14.28%; /* 固定宽度（7列均分） */
            min-width: 14.28%; /* 新增：最小宽度确保不收缩 */
            max-width: 14.28%; /* 新增：最大宽度确保不拉伸 */
            min-height: 90px; /* 新增：最小高度确保不收缩 */
            max-height: 90px; /* 新增：最大高度确保不拉伸 */
            vertical-align: top;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden; /* 隐藏超出内容 */
        }

        /* 日期单元格悬停效果 - 主题浅色 */
        .calendar-table td:hover {
            background-color: var(--primary-light);
            transform: scale(1.02);
        }

        /* 新历日期样式 - 调整回居中 */
        .date-text {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 3px;
            display: block; /* 改为块级元素 */
            text-align: center; /* 居中显示 */
            z-index: 1;
        }
        
        /* 周六/周日/法定节假日 - 主题色 */
        .weekend .date-text, .festival-day .date-text {
            color: var(--primary-color);
        }

        /* 周六/周日/法定节假日单元格背景 - 主题浅色 */
        .weekend, .festival-day {
            background-color: var(--primary-light);
        }

        /* 调休上班单元格背景 */
        .rest-work-day {
            background-color: white; /* 白色背景 */
        }

        /* 调休上班日期颜色 */
        .rest-work-day .date-text {
            color: #333; /* 黑色 */
        }

        /* 节假日样式 - 主题色 */
        .festival-text {
            font-size: 11px;
            color: var(--primary-color);
            font-weight: bold;
            line-height: 1.2;
            margin-bottom: 2px;
            text-align: center; /* 居中显示 */
        }

        /* 调休样式 - 黑色 */
        .rest-work-text {
            font-size: 11px; /* 和节假日统一大小 */
            color: #333; /* 黑色 */
            font-weight: bold; /* 和节假日统一加粗 */
            line-height: 1.2;
            margin-bottom: 2px;
            text-align: center; /* 居中显示 */
        }

        /* 蓝色节日样式 - 黑色（非法定节假日） */
        .blue-festival-text {
            font-size: 11px;
            color: #333; /* 黑色 */
            font-weight: bold;
            line-height: 1.2;
            margin-bottom: 2px;
            text-align: center; /* 居中显示 */
        }

        /* 今日日期高亮 - 优化 */
        .today {
            background-color: var(--today-bg); /* 白色背景 */
            border-radius: 8px;
            box-shadow: 0 0 8px var(--today-shadow);
        }
        .today:hover {
            background-color: var(--primary-light);
            color: #333;
        }
        .today:hover .date-text {
            color: var(--primary-color);
        }
        
        /* 今日文字样式 */
        .today-text {
            font-size: 11px;
            color: var(--today-text-color); /* 黄色 */
            font-weight: bold;
            line-height: 1.2;
            margin-bottom: 2px;
            text-align: center;
        }

        /* 标签样式 - 移到节日下方 */
        .schedule-tag {
            display: inline-block;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 10px;
            color: white;
            font-weight: bold;
            z-index: 2;
            max-width: 40px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin: 0 2px 2px 2px;
        }
        
        /* 标签容器 */
        .tag-container {
            text-align: center;
            margin-bottom: 2px;
        }

        /* 关键修改2：删除渐变效果，保留固定尺寸的日程内容容器 */
        .schedule-wrapper {
            display: none; /* 隐藏日程内容 */
        }

        /* 模态框样式（编辑日程用）- 新增删除按钮+标签功能 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .modal-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: var(--primary-color);
            transition: color 0.3s ease;
        }

        /* 标签选择区域 */
        .tag-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        /* 单个标签项 */
        .tag-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tag-color-select {
            padding: 8px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            outline: none;
            color: #333;
            font-size: 14px;
        }

        .tag-name-input {
            padding: 8px 10px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            outline: none;
            font-size: 14px;
            width: 80px;
            max-width: 80px;
        }
        
        /* 添加标签按钮样式 - 【修改1】统一尺寸+加粗符号 */
        .add-tag-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--btn-color);
            color: white;
            border: none;
            font-size: 12px;
            font-weight: bold; /* 加粗加号 */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s, transform 0.2s;
        }
        
        .add-tag-btn:hover {
            background-color: var(--btn-hover);
            transform: scale(1.1);
        }
        
        /* 删除标签按钮 - 【修改1】加粗减号 */
        .remove-tag-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #dc3545;
            color: white;
            border: none;
            font-size: 12px;
            font-weight: bold; /* 加粗减号 */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }
        
        .remove-tag-btn:hover {
            background-color: #c82333;
        }

        /* 【修改3】恢复日程输入框显示 */
        .schedule-input {
            width: 100%;
            height: 100px;
            padding: 10px;
            font-size: 16px;
            border: 2px solid var(--input-border);
            border-radius: 12px;
            margin-bottom: 15px;
            resize: none;
            outline: none;
            transition: border-color 0.3s ease;
            display: block; /* 恢复显示 */
        }

        .schedule-input:focus {
            border-color: var(--input-focus);
            box-shadow: 0 0 8px var(--primary-shadow);
        }

        .modal-btn-group {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .confirm-btn, .cancel-btn, .delete-btn {
            padding: 8px 15px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .confirm-btn {
            background-color: var(--btn-color);
            color: white;
        }

        .confirm-btn:hover {
            background-color: var(--btn-hover);
        }

        .cancel-btn {
            background-color: #e9ecef;
            color: #333;
        }

        .cancel-btn:hover {
            background-color: #dee2e6;
        }

        .delete-btn {
            background-color: #dc3545;
            color: white;
        }

        .delete-btn:hover {
            background-color: #c82333;
        }

        /* 自定义提示框样式 */
        .custom-alert {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 200;
            justify-content: center;
            align-items: center;
        }

        .alert-content {
            background-color: white;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 300px;
            text-align: center;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .alert-title {
            font-size: 18px;
            margin-bottom: 20px;
            color: #333;
        }

        .alert-btn-group {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .alert-confirm-btn, .alert-cancel-btn {
            padding: 8px 20px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .alert-confirm-btn {
            background-color: var(--btn-color);
            color: white;
        }

        .alert-confirm-btn:hover {
            background-color: var(--btn-hover);
        }

        .alert-cancel-btn {
            background-color: #e9ecef;
            color: #333;
        }

        .alert-cancel-btn:hover {
            background-color: #dee2e6;
        }
        
        /* 备注模块样式 */
        .notes-container {
            width: 100%;
            max-width: 800px;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        
        .notes-title {
            font-size: 18px;
            color: var(--primary-color);
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .notes-content {
            min-height: 80px; /* 三行高度 */
            line-height: 1.5;
            font-size: 16px;
            color: #333;
            padding: 10px;
            border: 2px solid var(--input-border);
            border-radius: 12px;
            text-align: left;
            white-space: pre-wrap;
            word-wrap: break-word;
            transition: border-color 0.3s;
            outline: none;
        }
        
        .notes-content:focus {
            border-color: var(--input-focus);
            box-shadow: 0 0 8px var(--primary-shadow);
        }
        
        /* 空备注时的提示文字 */
        .notes-content:empty:before {
            content: attr(placeholder);
            color: #999;
            font-style: italic;
        }
        
        .notes-btn-group {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
            display: none;
        }
        
        .notes-btn {
            padding: 8px 15px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .notes-save-btn {
            background-color: var(--btn-color);
            color: white;
        }
        
        .notes-save-btn:hover {
            background-color: var(--btn-hover);
        }
        
        .notes-cancel-btn {
            background-color: #e9ecef;
            color: #333;
        }
        
        .notes-cancel-btn:hover {
            background-color: #dee2e6;
        }
        
        .notes-delete-btn {
            background-color: #dc3545;
            color: white;
        }
        
        .notes-delete-btn:hover {
            background-color: #c82333;
        }
        
        /* 保存状态提示 */
        .save-status {
            font-size: 12px;
            color: #28a745;
            margin-left: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .save-status.show {
            opacity: 1;
        }

        /* 响应式适配 */
        @media (max-width: 600px) {
            .calendar-table th {
                padding: 8px;
                font-size: 14px;
                width: 14.28%; /* 移动端固定表头宽度 */
            }

            .calendar-table td {
                height: 80px;
                min-height: 80px;
                max-height: 80px;
                padding: 5px;
                width: 14.28%; /* 移动端固定单元格宽度 */
                min-width: 14.28%;
                max-width: 14.28%;
            }

            .init-section {
                padding: 30px 20px;
            }

            .init-title {
                font-size: 20px;
            }

            .calendar-title {
                font-size: 24px;
            }

            .date-text {
                font-size: 14px;
                text-align: center;
            }

            .festival-text, .blue-festival-text, .rest-work-text, .today-text {
                font-size: 10px;
                text-align: center;
            }

            /* 手机端颜色选择器优化 - 【修改2】调整到标题下方、月份栏上方且居中 */
            .calendar-color-selector {
                position: static; /* 取消绝对定位 */
                transform: none; /* 取消垂直居中 */
                margin: 0 auto 15px; /* 居中并添加底部间距 */
                justify-content: center; /* 水平居中 */
                width: fit-content; /* 宽度自适应内容 */
            }
            
            .calendar-color-selector .color-btn {
                width: 20px; 
                height: 20px;
            }

            .nav-btn {
                font-size: 18px;
                width: 25px;
                height: 25px;
            }

            .current-month {
                font-size: 20px;
            }

            /* 响应式调整日程内容容器 */
            .schedule-wrapper {
                display: none;
            }
            
            /* 手机端备注模块适配 */
            .notes-container {
                padding: 15px;
            }
            
            .notes-content {
                min-height: 70px;
                font-size: 14px;
            }
        }

        /* 【修改3】日程气泡样式 */
        .schedule-bubble {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            width: 80%;
            max-width: 400px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            z-index: 300;
        }
        
        .bubble-date {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-deep); /* 主题色的深色系 */
            margin-bottom: 10px;
            text-align: center;
        }
        
        .bubble-content {
            font-size: 16px;
            color: #333; /* 黑色 */
            font-weight: normal; /* 不加粗 */
            line-height: 1.5;
            white-space: pre-wrap;
        }
    </style>
<base target="_blank">
</head>
<body class="blue-theme">
    <!-- 初始化区域：输入名字（新增颜色选择） -->
    <div class="init-section" id="initSection">
        <!-- 颜色选择器 -->
        <div class="color-selector">
            <div class="color-btn pink" data-theme="pink-theme"></div>
            <div class="color-btn blue active" data-theme="blue-theme"></div>
            <div class="color-btn green" data-theme="green-theme"></div>
        </div>
        
        <div class="init-title">请输入你的名字</div>
        <input type="text" class="init-input" id="usernameInput" maxlength="8">
        <button class="init-btn" id="confirmNameBtn">确认</button>
    </div>

    <!-- 日程表标题 -->
    <h1 class="calendar-title" id="calendarTitle"></h1>

    <!-- 日历容器 -->
    <div class="calendar-container" id="calendarContainer">
        <!-- 移动端颜色选择器（移到月份导航上方） -->
        <div class="calendar-color-selector">
            <div class="color-btn pink" data-theme="pink-theme"></div>
            <div class="color-btn blue active" data-theme="blue-theme"></div>
            <div class="color-btn green" data-theme="green-theme"></div>
        </div>
        
        <!-- 月份切换区域 -->
        <div class="month-nav">
            <button class="nav-btn" id="prevMonthBtn">&lt;</button>
            <div class="current-month" id="currentMonthText"></div>
            <button class="nav-btn" id="nextMonthBtn">&gt;</button>
        </div>

        <!-- 日历表格 -->
        <table class="calendar-table" id="calendarTable">
            <thead>
                <tr>
                    <th>周日</th>
                    <th>周一</th>
                    <th>周二</th>
                    <th>周三</th>
                    <th>周四</th>
                    <th>周五</th>
                    <th>周六</th>
                </tr>
            </thead>
            <tbody id="calendarBody"></tbody>
        </table>
    </div>
    
    <!-- 备注模块 -->
    <div class="notes-container" id="notesContainer">
        <div class="notes-title">
            备注
            <span class="save-status" id="saveStatus">已自动保存</span>
        </div>
        <div class="notes-content" id="notesContent" contenteditable="true" placeholder="点击输入备注..."></div>
        <div class="notes-btn-group" id="notesBtnGroup">
            <button class="notes-btn notes-delete-btn" id="notesDeleteBtn">删除</button>
            <button class="notes-btn notes-cancel-btn" id="notesCancelBtn">取消</button>
            <button class="notes-btn notes-save-btn" id="notesSaveBtn">完成</button>
        </div>
    </div>

    <!-- 编辑日程的模态框（新增删除按钮+标签功能） -->
    <div class="modal" id="scheduleModal">
        <div class="modal-content">
            <h3 class="modal-title" id="modalTitle">编辑日程</h3>
            
            <!-- 标签选择区域 -->
            <div class="tag-selector" id="tagSelector">
                <div class="tag-item" id="tagItem1">
                    <select class="tag-color-select" id="tagColorSelect1">
                        <option value="#e74c3c">红色</option>
                        <option value="#3498db">蓝色</option>
                        <option value="#2ecc71">绿色</option>
                        <option value="#f1c40f">黄色</option>
                        <option value="#9b59b6">紫色</option>
                    </select>
                    <input type="text" class="tag-name-input" id="tagNameInput1" placeholder="标签名" maxlength="2">
                    <button class="remove-tag-btn" id="removeTagBtn1" style="display: none;">-</button>
                </div>
                <button class="add-tag-btn" id="addTagBtn">+</button>
            </div>

            <textarea class="schedule-input" id="scheduleInput" placeholder="请输入当天的日程..."></textarea>
            <div class="modal-btn-group">
                <button class="delete-btn" id="deleteScheduleBtn" style="display: none;">删除标签</button>
                <button class="cancel-btn" id="cancelBtn">取消</button>
                <button class="confirm-btn" id="saveScheduleBtn">确认</button>
            </div>
        </div>
    </div>

    <!-- 自定义提示框 -->
    <div class="custom-alert" id="customAlert">
        <div class="alert-content">
            <div class="alert-title" id="alertTitle"></div>
            <div class="alert-btn-group" id="alertBtnGroup">
                <button class="alert-cancel-btn" id="alertCancelBtn">取消</button>
                <button class="alert-confirm-btn" id="alertConfirmBtn">确认</button>
            </div>
        </div>
    </div>

    <!-- 【修改3】日程气泡容器 -->
    <div class="schedule-bubble" id="scheduleBubble">
        <div class="bubble-date" id="bubbleDate"></div>
        <div class="bubble-content" id="bubbleContent"></div>
    </div>

    <script>
        // 全局变量定义
        let currentDate = new Date(); // 当前显示的月份（初始为今天）
        let username = ""; // 用户名
        // 【修改3】扩展日程数据结构，增加content字段存储日程文字
        let scheduleData = {}; // 格式：{yyyy-mm-dd: {tags: [{color: "", name: ""}], content: ""}}
        let notesData = ""; // 备注数据
        let currentTheme = "blue-theme"; // 当前主题
        let alertCallback = null; // 提示框回调函数
        let maxTags = 3; // 最大标签数量
        let clickTimer = null; // 单击/双击检测定时器
        let bubbleActive = false; // 气泡是否显示
        let notesAutoSaveTimer = null; // 备注自动保存定时器
        let isNotesEditing = false; // 是否正在编辑备注

        // 2026年节假日配置（含调休）
        const holidayConfig = {
            // 法定节假日（主题色）
            "2026-01-01": { type: "festival", name: "元旦" },
            "2026-01-02": { type: "festival", name: "元旦" },
            "2026-01-03": { type: "festival", name: "元旦" },
            "2026-02-15": { type: "festival", name: "春节" },
            "2026-02-16": { type: "festival", name: "春节" },
            "2026-02-17": { type: "festival", name: "春节" },
            "2026-02-18": { type: "festival", name: "春节" },
            "2026-02-19": { type: "festival", name: "春节" },
            "2026-02-20": { type: "festival", name: "春节" },
            "2026-02-21": { type: "festival", name: "春节" },
            "2026-02-22": { type: "festival", name: "春节" },
            "2026-02-23": { type: "festival", name: "春节" },
            "2026-04-04": { type: "festival", name: "清明节" },
            "2026-04-05": { type: "festival", name: "清明节" },
            "2026-04-06": { type: "festival", name: "清明节" },
            "2026-05-01": { type: "festival", name: "劳动节" },
            "2026-05-02": { type: "festival", name: "劳动节" },
            "2026-05-03": { type: "festival", name: "劳动节" },
            "2026-05-04": { type: "festival", name: "劳动节" },
            "2026-05-05": { type: "festival", name: "劳动节" },
            "2026-06-19": { type: "festival", name: "端午节" },
            "2026-06-20": { type: "festival", name: "端午节" },
            "2026-06-21": { type: "festival", name: "端午节" },
            "2026-09-25": { type: "festival", name: "中秋节" },
            "2026-09-26": { type: "festival", name: "中秋节" },
            "2026-09-27": { type: "festival", name: "中秋节" },
            "2026-10-01": { type: "festival", name: "国庆节" },
            "2026-10-02": { type: "festival", name: "国庆节" },
            "2026-10-03": { type: "festival", name: "国庆节" },
            "2026-10-04": { type: "festival", name: "国庆节" },
            "2026-10-05": { type: "festival", name: "国庆节" },
            "2026-10-06": { type: "festival", name: "国庆节" },
            "2026-10-07": { type: "festival", name: "国庆节" },
            
            // 调休上班（黑色）
            "2026-01-04": { type: "restWork", name: "调休上班" },
            "2026-02-14": { type: "restWork", name: "调休上班" },
            "2026-02-28": { type: "restWork", name: "调休上班" },
            "2026-05-09": { type: "restWork", name: "调休上班" },
            "2026-09-20": { type: "restWork", name: "调休上班" },
            "2026-10-10": { type: "restWork", name: "调休上班" },

            // 其他节日（黑色）
            "2026-03-03": { type: "blueFestival", name: "元宵节" },
            "2026-02-14": { type: "blueFestival", name: "情人节" },
            "2026-03-08": { type: "blueFestival", name: "妇女节" },
            "2026-03-12": { type: "blueFestival", name: "植树节" },
            "2026-03-15": { type: "blueFestival", name: "消费者权益日" },
            "2026-04-01": { type: "blueFestival", name: "愚人节" },
            "2026-04-05": { type: "blueFestival", name: "复活节" },
            "2026-04-22": { type: "blueFestival", name: "地球日" },
            "2026-05-04": { type: "blueFestival", name: "青年节" },
            "2026-05-12": { type: "blueFestival", name: "护士节" },
            "2026-05-10": { type: "blueFestival", name: "母亲节" },
            "2026-06-01": { type: "blueFestival", name: "儿童节" },
            "2026-06-21": { type: "blueFestival", name: "父亲节" },
            "2026-07-01": { type: "blueFestival", name: "建党节" },
            "2026-08-01": { type: "blueFestival", name: "建军节" },
            "2026-08-19": { type: "blueFestival", name: "七夕节" },
            "2026-09-05": { type: "blueFestival", name: "中元节" },
            "2026-09-10": { type: "blueFestival", name: "教师节" },
            "2026-10-18": { type: "blueFestival", name: "重阳节" },
            "2026-10-31": { type: "blueFestival", name: "万圣节" },
            "2026-12-24": { type: "blueFestival", name: "平安夜" },
            "2026-12-25": { type: "blueFestival", name: "圣诞节" }
        };

        // DOM元素获取
        const initSection = document.getElementById("initSection");
        const colorBtns = document.querySelectorAll(".color-btn");
        const usernameInput = document.getElementById("usernameInput");
        const confirmNameBtn = document.getElementById("confirmNameBtn");
        const calendarTitle = document.getElementById("calendarTitle");
        const calendarContainer = document.getElementById("calendarContainer");
        const prevMonthBtn = document.getElementById("prevMonthBtn");
        const nextMonthBtn = document.getElementById("nextMonthBtn");
        const currentMonthText = document.getElementById("currentMonthText");
        const calendarBody = document.getElementById("calendarBody");
        const scheduleModal = document.getElementById("scheduleModal");
        const modalTitle = document.getElementById("modalTitle");
        const tagSelector = document.getElementById("tagSelector");
        const addTagBtn = document.getElementById("addTagBtn");
        const scheduleInput = document.getElementById("scheduleInput");
        const cancelBtn = document.getElementById("cancelBtn");
        const saveScheduleBtn = document.getElementById("saveScheduleBtn");
        const deleteScheduleBtn = document.getElementById("deleteScheduleBtn");
        
        // 备注模块元素
        const notesContainer = document.getElementById("notesContainer");
        const notesContent = document.getElementById("notesContent");
        const notesBtnGroup = document.getElementById("notesBtnGroup");
        const notesSaveBtn = document.getElementById("notesSaveBtn");
        const notesCancelBtn = document.getElementById("notesCancelBtn");
        const notesDeleteBtn = document.getElementById("notesDeleteBtn");
        const saveStatus = document.getElementById("saveStatus");
        
        // 自定义提示框元素
        const customAlert = document.getElementById("customAlert");
        const alertTitle = document.getElementById("alertTitle");
        const alertBtnGroup = document.getElementById("alertBtnGroup");
        const alertCancelBtn = document.getElementById("alertCancelBtn");
        const alertConfirmBtn = document.getElementById("alertConfirmBtn");

        // 【修改3】日程气泡元素
        const scheduleBubble = document.getElementById("scheduleBubble");
        const bubbleDate = document.getElementById("bubbleDate");
        const bubbleContent = document.getElementById("bubbleContent");

        // 当前编辑的日期
        let editingDate = "";
        // 原始备注内容（用于取消编辑时恢复）
        let originalNotesContent = "";

        // ===================== localStorage 持久化核心函数 =====================
        /**
         * 保存数据到localStorage
         * 把用户名、主题、日程、备注等关键数据转成JSON字符串存储
         */
        function saveToLocalStorage() {
            // 定义要保存的数据结构
            const saveData = {
                username: username,          // 用户名
                scheduleData: scheduleData,  // 日程数据（标签+文字）
                notesData: notesData,        // 备注数据
                currentTheme: currentTheme   // 当前主题颜色
            };
            // localStorage只能存储字符串，所以用JSON.stringify转换
            localStorage.setItem("calendar", JSON.stringify(saveData));
        }

        /**
         * 从localStorage读取数据
         * 读取后解析JSON字符串，恢复到全局变量中
         * @returns {boolean} 是否读取到有效数据
         */
        function loadFromLocalStorage() {
            // 从localStorage获取保存的字符串
            const savedStr = localStorage.getItem("calendar");
            if (!savedStr) {
                // 没有保存的数据，返回false
                return false;
            }
            
            try {
                // 解析JSON字符串为对象
                const savedData = JSON.parse(savedStr);
                // 恢复全局变量（给默认值，防止数据结构不完整）
                username = savedData.username || "";
                scheduleData = savedData.scheduleData || {};
                notesData = savedData.notesData || "";
                currentTheme = savedData.currentTheme || "blue-theme";
                
                // 应用主题样式
                document.body.className = currentTheme;
                // 更新颜色选择器的active状态
                colorBtns.forEach(btn => {
                    if (btn.dataset.theme === currentTheme) {
                        btn.classList.add("active");
                    } else {
                        btn.classList.remove("active");
                    }
                });
                
                return true;
            } catch (e) {
                // 解析失败（数据损坏），返回false
                console.error("读取本地数据失败：", e);
                return false;
            }
        }

        // ===================== 备注自动保存功能 =====================
        /**
         * 显示保存状态提示
         */
        function showSaveStatus() {
            saveStatus.classList.add("show");
            setTimeout(() => {
                saveStatus.classList.remove("show");
            }, 2000);
        }

        /**
         * 自动保存备注内容
         */
        function autoSaveNotes() {
            const content = notesContent.innerText || "";
            notesData = content.trim();
            saveToLocalStorage();
            showSaveStatus();
        }

        /**
         * 启动自动保存定时器（防抖）
         */
        function startAutoSaveTimer() {
            // 清除之前的定时器
            if (notesAutoSaveTimer) {
                clearTimeout(notesAutoSaveTimer);
            }
            // 设置新的定时器，1秒后自动保存
            notesAutoSaveTimer = setTimeout(() => {
                autoSaveNotes();
            }, 1000);
        }

        // ===================== 原有功能逻辑（添加了保存调用） =====================
        // 1. 颜色主题切换功能
        // 初始化颜色按钮事件
        function initColorBtnEvents() {
            colorBtns.forEach(btn => {
                // 点击切换主题
                btn.addEventListener("click", function() {
                    // 移除所有按钮的active状态
                    document.querySelectorAll(".color-btn").forEach(b => b.classList.remove("active"));
                    // 添加当前按钮的active状态
                    this.classList.add("active");
                    // 获取主题名称
                    currentTheme = this.dataset.theme;
                    // 切换body的主题类
                    document.body.className = currentTheme;
                    
                    // 新增：切换主题后保存数据
                    saveToLocalStorage();
                });

                // 修复：初始化区域颜色按钮的悬浮预览效果
                if (btn.closest('.init-section')) {
                    btn.addEventListener("mouseenter", function() {
                        // 非当前激活按钮才预览主题
                        if (!this.classList.contains("active")) {
                            document.body.className = this.dataset.theme;
                        }
                    });
                    btn.addEventListener("mouseleave", function() {
                        // 离开后恢复原始主题
                        if (!this.classList.contains("active")) {
                            document.body.className = currentTheme;
                        }
                    });
                }
            });
        }

        // 2. 自定义提示框函数
        function showAlert(message, isConfirm = false, callback = null) {
            alertTitle.textContent = message;
            alertCallback = callback;
            
            // 显示/隐藏取消按钮
            if (isConfirm) {
                alertCancelBtn.style.display = "block";
                alertBtnGroup.style.justifyContent = "center";
            } else {
                alertCancelBtn.style.display = "none";
                // 只有确认按钮时，居中显示
                alertBtnGroup.style.justifyContent = "center";
            }
            
            customAlert.style.display = "flex";
        }

        // 提示框取消按钮
        alertCancelBtn.addEventListener("click", function() {
            customAlert.style.display = "none";
            alertCallback = null;
        });

        // 提示框确认按钮
        alertConfirmBtn.addEventListener("click", function() {
            customAlert.style.display = "none";
            if (alertCallback) {
                alertCallback(true);
                alertCallback = null;
            }
        });

        // 3. 初始化：确认用户名
        confirmNameBtn.addEventListener("click", function() {
            username = usernameInput.value.trim();
            if (!username) {
                showAlert("请输入你的名字！");
                return;
            }
            // 设置标题
            calendarTitle.textContent = `${username}的日程表`;
            // 显示标题、日历容器和备注模块
            calendarTitle.style.display = "block";
            calendarContainer.style.display = "block";
            notesContainer.style.display = "block";
            // 初始化备注内容
            notesContent.textContent = notesData;
            // 隐藏初始化输入框和按钮
            initSection.style.display = "none";
            // 渲染日历
            renderCalendar();
            
            // 新增：确认用户名后保存数据
            saveToLocalStorage();
        });

        // 4. 月份切换事件
        prevMonthBtn.addEventListener("click", function() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        nextMonthBtn.addEventListener("click", function() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        // 5. 渲染日历核心函数
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth(); // 0-11
            const today = new Date(); // 今天的日期
            const todayYear = today.getFullYear();
            const todayMonth = today.getMonth();
            const todayDay = today.getDate();

            // 更新月份显示文本
            currentMonthText.textContent = `${year}年${month + 1}月`;

            // 清空日历表格
            calendarBody.innerHTML = "";

            // 获取当月第一天
            const firstDay = new Date(year, month, 1);
            // 第一天是星期几（0=周日，6=周六）
            const firstDayWeek = firstDay.getDay();

            // 获取当月最后一天
            const lastDay = new Date(year, month + 1, 0);
            const lastDayDate = lastDay.getDate();

            // 计算需要渲染的总天数（包含上月和下月的填充）
            let dayCount = 0;
            let row; // 表格行

            // 先填充上月的空白
            for (let i = 0; i < firstDayWeek; i++) {
                if (i % 7 === 0) {
                    row = document.createElement("tr");
                    calendarBody.appendChild(row);
                }
                const td = document.createElement("td");
                td.style.color = "#ccc";
                row.appendChild(td);
                dayCount++;
            }

            // 渲染当月的日期
            for (let day = 1; day <= lastDayDate; day++) {
                if (dayCount % 7 === 0) {
                    row = document.createElement("tr");
                    calendarBody.appendChild(row);
                }

                const td = document.createElement("td");
                const monthStr = String(month + 1).padStart(2, "0");
                const dayStr = String(day).padStart(2, "0");
                const currentDateStr = `${year}-${monthStr}-${dayStr}`;
                // 判断是否是周末（0=周日，6=周六）
                const dayWeek = new Date(year, month, day).getDay();
                const isWeekend = dayWeek === 0 || dayWeek === 6;
                // 判断是否是法定节假日
                const isFestival = holidayConfig[currentDateStr]?.type === "festival";
                // 判断是否是调休上班
                const isRestWork = holidayConfig[currentDateStr]?.type === "restWork";

                // 标记周末
                if (isWeekend) {
                    td.classList.add("weekend");
                }

                // 标记法定节假日
                if (isFestival) {
                    td.classList.add("festival-day");
                }

                // 标记调休上班
                if (isRestWork) {
                    td.classList.add("rest-work-day");
                }

                // 1. 日期显示区域（居中）
                const dateDiv = document.createElement("div");
                dateDiv.className = "date-text";
                dateDiv.textContent = day;
                td.appendChild(dateDiv);

                // 2. 今日标记
                if (year === todayYear && month === todayMonth && day === todayDay) {
                    td.classList.add("today");
                    const todayDiv = document.createElement("div");
                    todayDiv.className = "today-text";
                    todayDiv.textContent = "今日";
                    td.appendChild(todayDiv);
                }

                // 3. 节假日/调休/其他节日标注
                if (holidayConfig[currentDateStr]) {
                    const holiday = holidayConfig[currentDateStr];
                    let holidayDiv;
                    
                    if (holiday.type === "festival") {
                        // 法定节假日（主题色）
                        holidayDiv = document.createElement("div");
                        holidayDiv.className = "festival-text";
                        holidayDiv.textContent = holiday.name;
                    } else if (holiday.type === "restWork") {
                        // 调休上班（黑色）
                        holidayDiv = document.createElement("div");
                        holidayDiv.className = "rest-work-text";
                        holidayDiv.textContent = holiday.name;
                    } else if (holiday.type === "blueFestival") {
                        // 其他节日（黑色）
                        holidayDiv = document.createElement("div");
                        holidayDiv.className = "blue-festival-text";
                        holidayDiv.textContent = holiday.name;
                    }
                    
                    if (holidayDiv) td.appendChild(holidayDiv);
                }

                // 4. 标签显示（节日下方）
                if (scheduleData[currentDateStr]?.tags && scheduleData[currentDateStr].tags.length > 0) {
                    const tagContainer = document.createElement("div");
                    tagContainer.className = "tag-container";
                    
                    scheduleData[currentDateStr].tags.forEach(tag => {
                        if (tag.name) {
                            const tagDiv = document.createElement("span");
                            tagDiv.className = "schedule-tag";
                            tagDiv.style.backgroundColor = tag.color;
                            tagDiv.textContent = tag.name;
                            tagContainer.appendChild(tagDiv);
                        }
                    });
                    
                    td.appendChild(tagContainer);
                }

                // ========== 核心修复：重构单元格点击/双击事件 ==========
                // 1. 先绑定双击事件（优先级最高）
                td.addEventListener("dblclick", function(e) {
                    e.preventDefault(); // 阻止默认行为
                    e.stopPropagation(); // 阻止事件冒泡
                    
                    // 清除单击定时器（防止触发单击逻辑）
                    if (clickTimer) {
                        clearTimeout(clickTimer);
                        clickTimer = null;
                    }
                    
                    // 如果气泡已显示，先关闭
                    if (bubbleActive) {
                        hideScheduleBubble();
                    } else {
                        // 显示日程气泡
                        showScheduleBubble(currentDateStr, day);
                    }
                });

                // 2. 绑定单击事件
                td.addEventListener("click", function(e) {
                    e.stopPropagation();
                    
                    // 如果气泡已显示，点击单元格关闭气泡
                    if (bubbleActive) {
                        hideScheduleBubble();
                        return;
                    }
                    
                    // 双击检测：如果300ms内没有第二次点击，视为单击
                    if (clickTimer) {
                        clearTimeout(clickTimer);
                        clickTimer = null;
                        return; // 第二次点击由dblclick处理
                    }
                    
                    // 设置单击定时器
                    clickTimer = setTimeout(() => {
                        clickTimer = null;
                        // 打开编辑模态框
                        openEditModal(currentDateStr, day);
                    }, 300);
                });

                row.appendChild(td);
                dayCount++;
            }

            // 填充下月的空白
            while (dayCount % 7 !== 0) {
                const td = document.createElement("td");
                td.style.color = "#ccc";
                row.appendChild(td);
                dayCount++;
            }
        }

        // 【修复】显示日程气泡
        function showScheduleBubble(dateStr, day) {
            // 格式化日期显示
            const dateObj = new Date(dateStr);
            const year = dateObj.getFullYear();
            const month = dateObj.getMonth() + 1;
            bubbleDate.textContent = `${year}年${month}月${day}日`;
            
            // 设置日程内容
            bubbleContent.textContent = scheduleData[dateStr]?.content || "暂无日程记录";
            
            // 显示气泡
            scheduleBubble.style.display = "block";
            bubbleActive = true;
            
            // 给气泡添加点击关闭事件
            scheduleBubble.onclick = function(e) {
                e.stopPropagation();
                hideScheduleBubble();
            };
        }

        // 【修复】隐藏日程气泡
        function hideScheduleBubble() {
            scheduleBubble.style.display = "none";
            bubbleActive = false;
        }

        // 6. 添加标签按钮事件
        addTagBtn.addEventListener("click", function() {
            const tagItems = document.querySelectorAll(".tag-item");
            if (tagItems.length >= maxTags) {
                showAlert(`最多只能添加${maxTags}个标签！`);
                return;
            }
            
            const newIndex = tagItems.length + 1;
            const newTagItem = document.createElement("div");
            newTagItem.className = "tag-item";
            newTagItem.id = `tagItem${newIndex}`;
            
            newTagItem.innerHTML = `
                <select class="tag-color-select" id="tagColorSelect${newIndex}">
                    <option value="#e74c3c">红色</option>
                    <option value="#3498db">蓝色</option>
                    <option value="#2ecc71">绿色</option>
                    <option value="#f1c40f">黄色</option>
                    <option value="#9b59b6">紫色</option>
                </select>
                <input type="text" class="tag-name-input" id="tagNameInput${newIndex}" placeholder="标签名" maxlength="2">
                <button class="remove-tag-btn" id="removeTagBtn${newIndex}">-</button>
            `;
            
            // 插入到添加按钮前面
            tagSelector.insertBefore(newTagItem, addTagBtn);
            
            // 显示已有的删除按钮
            document.querySelectorAll(".remove-tag-btn").forEach(btn => {
                btn.style.display = "flex";
            });
            
            // 添加删除标签按钮事件
            document.getElementById(`removeTagBtn${newIndex}`).addEventListener("click", function() {
                newTagItem.remove();
                // 如果只剩一个标签项，隐藏删除按钮
                if (document.querySelectorAll(".tag-item").length <= 1) {
                    document.querySelector(".remove-tag-btn").style.display = "none";
                }
            });
        });

        // 初始化第一个删除标签按钮事件
        document.getElementById("removeTagBtn1").addEventListener("click", function() {
            const tagItems = document.querySelectorAll(".tag-item");
            if (tagItems.length > 1) {
                document.getElementById("tagItem1").remove();
                // 如果只剩一个标签项，隐藏删除按钮
                if (document.querySelectorAll(".tag-item").length <= 1) {
                    document.querySelector(".remove-tag-btn").style.display = "none";
                }
            }
        });

        // 7. 打开编辑日程的模态框 - 【核心修复】保留原有标签和内容
        function openEditModal(dateStr, day) {
            editingDate = dateStr;
            modalTitle.textContent = `编辑${dateStr}的日程`;
            
            // 清空现有标签项（保留第一个）
            const existingTagItems = document.querySelectorAll(".tag-item");
            existingTagItems.forEach((item, index) => {
                if (index > 0) {
                    item.remove();
                }
            });
            
            // 获取当前日期的已有数据
            const existingData = scheduleData[dateStr] || { tags: [], content: "" };
            
            // 【修复1】恢复原有标签数据
            if (existingData.tags && existingData.tags.length > 0) {
                // 填充第一个标签
                document.getElementById("tagColorSelect1").value = existingData.tags[0].color || "#e74c3c";
                document.getElementById("tagNameInput1").value = existingData.tags[0].name || "";
                
                // 如果有多个标签，动态创建
                for (let i = 1; i < existingData.tags.length; i++) {
                    const tag = existingData.tags[i];
                    const newIndex = i + 1;
                    const newTagItem = document.createElement("div");
                    newTagItem.className = "tag-item";
                    newTagItem.id = `tagItem${newIndex}`;
                    
                    newTagItem.innerHTML = `
                        <select class="tag-color-select" id="tagColorSelect${newIndex}">
                            <option value="#e74c3c">红色</option>
                            <option value="#3498db">蓝色</option>
                            <option value="#2ecc71">绿色</option>
                            <option value="#f1c40f">黄色</option>
                            <option value="#9b59b6">紫色</option>
                        </select>
                        <input type="text" class="tag-name-input" id="tagNameInput${newIndex}" placeholder="标签名" maxlength="2" value="${tag.name || ''}">
                        <button class="remove-tag-btn" id="removeTagBtn${newIndex}">-</button>
                    `;
                    
                    // 插入到添加按钮前面
                    tagSelector.insertBefore(newTagItem, addTagBtn);
                    
                    // 设置标签颜色
                    const colorSelect = document.getElementById(`tagColorSelect${newIndex}`);
                    if (colorSelect) {
                        colorSelect.value = tag.color || "#e74c3c";
                    }
                    
                    // 添加删除事件
                    document.getElementById(`removeTagBtn${newIndex}`).addEventListener("click", function() {
                        newTagItem.remove();
                        if (document.querySelectorAll(".tag-item").length <= 1) {
                            document.querySelector(".remove-tag-btn").style.display = "none";
                        }
                    });
                }
                
                // 显示删除按钮（如果有多个标签）
                if (existingData.tags.length > 1) {
                    document.querySelectorAll(".remove-tag-btn").forEach(btn => {
                        btn.style.display = "flex";
                    });
                } else {
                    document.getElementById("removeTagBtn1").style.display = "none";
                }
            } else {
                // 没有原有标签，重置第一个标签
                document.getElementById("tagColorSelect1").value = "#e74c3c";
                document.getElementById("tagNameInput1").value = "";
                document.getElementById("removeTagBtn1").style.display = "none";
            }
            
            // 【修复2】恢复原有日程文字内容
            scheduleInput.value = existingData.content || "";
            
            // 显示删除按钮（如果有数据）
            deleteScheduleBtn.style.display = (existingData.tags.length > 0 || existingData.content) ? "block" : "none";
            
            // 显示模态框
            scheduleModal.style.display = "flex";
        }

        // 8. 取消按钮事件（关闭模态框）
        cancelBtn.addEventListener("click", function() {
            scheduleModal.style.display = "none";
            editingDate = "";
        });

        // 9. 保存日程按钮事件
        saveScheduleBtn.addEventListener("click", function() {
            if (!editingDate) return;
            
            // 收集标签数据
            const tagItems = document.querySelectorAll(".tag-item");
            const tags = [];
            
            tagItems.forEach((item, index) => {
                const colorSelect = document.getElementById(`tagColorSelect${index + 1}`);
                const nameInput = document.getElementById(`tagNameInput${index + 1}`);
                
                if (colorSelect && nameInput) {
                    const color = colorSelect.value;
                    const name = nameInput.value.trim();
                    if (name) {
                        tags.push({ color, name });
                    }
                }
            });
            
            // 收集日程文字内容
            const content = scheduleInput.value.trim();
            
            // 保存数据
            if (tags.length > 0 || content) {
                scheduleData[editingDate] = {
                    tags: tags,
                    content: content
                };
            } else {
                // 没有标签和内容，删除该日期的数据
                delete scheduleData[editingDate];
            }
            
            // 保存到本地存储
            saveToLocalStorage();
            
            // 关闭模态框
            scheduleModal.style.display = "none";
            editingDate = "";
            
            // 重新渲染日历
            renderCalendar();
        });

        // 10. 删除日程按钮事件
        deleteScheduleBtn.addEventListener("click", function() {
            showAlert("确定要删除该日期的所有日程和标签吗？", true, function(confirm) {
                if (confirm && editingDate) {
                    // 删除该日期的数据
                    delete scheduleData[editingDate];
                    // 保存到本地存储
                    saveToLocalStorage();
                    // 关闭模态框
                    scheduleModal.style.display = "none";
                    editingDate = "";
                    // 重新渲染日历
                    renderCalendar();
                }
            });
        });

        // 11. 备注模块事件（增强版：支持自动保存）
        // 备注内容获得焦点时
        notesContent.addEventListener("focus", function() {
            isNotesEditing = true;
            originalNotesContent = notesContent.innerText || "";
            notesBtnGroup.style.display = "flex";
        });

        // 备注内容输入时（实时自动保存）
        notesContent.addEventListener("input", function() {
            if (isNotesEditing) {
                startAutoSaveTimer();
            }
        });

        // 保存备注按钮
        notesSaveBtn.addEventListener("click", function() {
            // 清除自动保存定时器
            if (notesAutoSaveTimer) {
                clearTimeout(notesAutoSaveTimer);
                notesAutoSaveTimer = null;
            }
            
            notesData = (notesContent.innerText || "").trim();
            saveToLocalStorage();
            isNotesEditing = false;
            notesBtnGroup.style.display = "none";
            showAlert("备注保存成功！");
        });

        // 取消备注编辑
        notesCancelBtn.addEventListener("click", function() {
            // 清除自动保存定时器
            if (notesAutoSaveTimer) {
                clearTimeout(notesAutoSaveTimer);
                notesAutoSaveTimer = null;
            }
            
            notesContent.textContent = originalNotesContent;
            notesData = originalNotesContent;
            isNotesEditing = false;
            notesBtnGroup.style.display = "none";
        });

        // 删除备注
        notesDeleteBtn.addEventListener("click", function() {
            showAlert("确定要清空备注内容吗？", true, function(confirm) {
                if (confirm) {
                    // 清除自动保存定时器
                    if (notesAutoSaveTimer) {
                        clearTimeout(notesAutoSaveTimer);
                        notesAutoSaveTimer = null;
                    }
                    
                    notesData = "";
                    notesContent.textContent = "";
                    saveToLocalStorage();
                    isNotesEditing = false;
                    notesBtnGroup.style.display = "none";
                    showAlert("备注已清空！");
                }
            });
        });

        // 12. 点击空白处关闭气泡
        document.addEventListener("click", function(e) {
            if (bubbleActive && !scheduleBubble.contains(e.target) && !e.target.closest('.calendar-table td')) {
                hideScheduleBubble();
            }
        });

        // 13. 页面离开前自动保存备注
        window.addEventListener("beforeunload", function() {
            if (isNotesEditing) {
                const content = notesContent.innerText || "";
                notesData = content.trim();
                saveToLocalStorage();
            }
        });

        // ===================== 页面初始化 =====================
        // 读取本地存储数据
        loadFromLocalStorage();
        
        // 初始化颜色按钮事件
        initColorBtnEvents();
        
        // 如果已有用户名，直接显示日程表
        if (username) {
            calendarTitle.textContent = `${username}的日程表`;
            calendarTitle.style.display = "block";
            calendarContainer.style.display = "block";
            notesContainer.style.display = "block";
            // 确保备注内容正确恢复
            notesContent.textContent = notesData;
            initSection.style.display = "none";
            renderCalendar();
        }
    </script>
</body>
</html>